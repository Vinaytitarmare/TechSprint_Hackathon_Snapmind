class h{constructor(){this.blockIdCounter=0}extract(){this.blockIdCounter=0;const t=this.findMainContent(),e=this.traverse(t.element),o=e.reduce((i,s)=>i+s.text.length,0);return{url:window.location.href,title:document.title,blocks:e,contentScore:o}}findMainContent(){const t=["article","main",'[role="main"]',"#content","#main",".main-content"];for(const e of t){const o=document.querySelector(e);if(o)return{element:o,type:e}}return{element:document.body,type:"body"}}traverse(t){let e=[];if(this.shouldIgnore(t))return[];if(t.nodeType===Node.TEXT_NODE){const o=t.textContent.trim();return o.length>20&&e.push(this.createBlock("text",o,t.parentNode)),e}if(t.nodeType===Node.ELEMENT_NODE){const o=t.tagName.toLowerCase();if(["h1","h2","h3","h4","h5","h6"].includes(o))return e.push(this.createBlock("heading",t.textContent.trim(),t)),e;if(o==="p"){const i=t.textContent.trim();return i.length>0&&e.push(this.createBlock("paragraph",i,t)),e}for(const i of t.childNodes)e=e.concat(this.traverse(i))}return e}shouldIgnore(t){if(t.nodeType===Node.ELEMENT_NODE){const e=t.tagName.toLowerCase();if(["script","style","noscript","svg","iframe","button","nav","footer","header"].includes(e))return!0;const o=window.getComputedStyle(t);if(o.display==="none"||o.visibility==="hidden")return!0}return!1}createBlock(t,e,o){const i=`bi-block-${this.blockIdCounter++}`;return o&&o.nodeType===Node.ELEMENT_NODE&&(o.dataset.biBlockId||(o.dataset.biBlockId=i)),{id:i,type:t,text:e}}}class d{constructor(){this.activeHighlight=null}highlight(t){this.clearHighlight();const e=document.querySelector(`[data-bi-block-id="${t}"]`);if(!e)return console.warn(`[Highlighter] Block not found: ${t}`),!1;e.scrollIntoView({behavior:"smooth",block:"center"});const o=e.style.transition,i=e.style.backgroundColor;return e.style.transition="background-color 0.5s ease",e.style.backgroundColor="rgba(255, 255, 0, 0.4)",this.activeHighlight={element:e,originalTransition:o,originalBackground:i,timeout:setTimeout(()=>this.clearHighlight(),4e3)},!0}clearHighlight(){if(this.activeHighlight){const{element:t,originalTransition:e,originalBackground:o,timeout:i}=this.activeHighlight;clearTimeout(i),t.style.backgroundColor="rgba(255, 255, 0, 0)",setTimeout(()=>{t.style.backgroundColor=o,t.style.transition=e},500),this.activeHighlight=null}}}class u{constructor(){this.overlay=null,this.selectionBox=null,this.instructions=null,this.toolbar=null,this.startX=0,this.startY=0,this.isSelecting=!1,this.isLocked=!1,this.resolveSelection=null}start(){return new Promise(t=>{this.resolveSelection=t,this.overlay=document.createElement("div"),Object.assign(this.overlay.style,{position:"fixed",top:"0",left:"0",width:"100vw",height:"100vh",zIndex:"2147483647",cursor:"crosshair",backgroundColor:"rgba(0, 0, 0, 0.4)",userSelect:"none"}),this.instructions=document.createElement("div"),this.instructions.textContent="Drag to select area. Press ESC to cancel.",Object.assign(this.instructions.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#1f2937",color:"white",padding:"8px 16px",borderRadius:"8px",fontSize:"14px",fontFamily:"sans-serif",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",pointerEvents:"none",zIndex:"2147483648"}),this.overlay.appendChild(this.instructions),this.selectionBox=document.createElement("div"),Object.assign(this.selectionBox.style,{position:"fixed",border:"2px solid #6366f1",backgroundColor:"rgba(99, 102, 241, 0.15)",boxShadow:"0 0 0 9999px rgba(0, 0, 0, 0.2)",display:"none",zIndex:"2147483648"}),this.overlay.appendChild(this.selectionBox),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.overlay.addEventListener("mousedown",this.onMouseDown),document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("keydown",this.onKeyDown),document.body.appendChild(this.overlay)})}cleanup(){this.overlay&&this.overlay.remove(),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),document.removeEventListener("keydown",this.onKeyDown),this.overlay=null,this.selectionBox=null,this.instructions=null,this.toolbar=null,this.isSelecting=!1,this.isLocked=!1}createToolbar(t){this.toolbar&&this.toolbar.remove(),this.toolbar=document.createElement("div"),Object.assign(this.toolbar.style,{position:"absolute",left:"0px",top:"100%",marginTop:"8px",display:"flex",gap:"8px",pointerEvents:"auto"});const e=(s,l,c)=>{const r=document.createElement("button");return r.textContent=s,Object.assign(r.style,{backgroundColor:l,color:"white",border:"none",padding:"6px 12px",borderRadius:"6px",cursor:"pointer",fontSize:"12px",fontWeight:"600",fontFamily:"sans-serif",boxShadow:"0 2px 4px rgba(0,0,0,0.2)"}),r.onclick=a=>{a.stopPropagation(),c()},r},o=e("Analyze","#10b981",()=>this.confirmSelection()),i=e("Cancel","#ef4444",()=>this.cleanupAndResolve(null));this.toolbar.appendChild(o),this.toolbar.appendChild(i),this.selectionBox.appendChild(this.toolbar)}confirmSelection(){const t=this.selectionBox.getBoundingClientRect(),e={x:t.left,y:t.top,width:t.width,height:t.height,windowWidth:window.innerWidth,windowHeight:window.innerHeight,devicePixelRatio:window.devicePixelRatio};this.cleanupAndResolve(e)}cleanupAndResolve(t){this.cleanup(),this.resolveSelection&&this.resolveSelection(t)}onMouseDown(t){if(t.target.tagName!=="BUTTON"){if(this.isLocked){this.isLocked=!1,this.toolbar&&(this.toolbar.remove(),this.toolbar=null),this.isSelecting=!0,this.startX=t.clientX,this.startY=t.clientY,this.updateBox(this.startX,this.startY,0,0);return}this.isSelecting=!0,this.startX=t.clientX,this.startY=t.clientY,this.updateBox(this.startX,this.startY,0,0)}}onMouseMove(t){if(!this.isSelecting)return;const e=t.clientX,o=t.clientY,i=Math.abs(e-this.startX),s=Math.abs(o-this.startY),l=Math.min(e,this.startX),c=Math.min(o,this.startY);this.updateBox(l,c,i,s)}updateBox(t,e,o,i){Object.assign(this.selectionBox.style,{left:`${t}px`,top:`${e}px`,width:`${o}px`,height:`${i}px`,display:"block"})}onMouseUp(t){if(!this.isSelecting)return;this.isSelecting=!1;const e=this.selectionBox.getBoundingClientRect();if(e.width<10||e.height<10){Object.assign(this.selectionBox.style,{display:"none"});return}this.isLocked=!0,this.createToolbar(e)}onKeyDown(t){t.key==="Escape"&&this.cleanupAndResolve(null)}}console.log("Context-Aware Browser Intelligence: Content script loaded");const g=new h,p=new d,b=new u;chrome.runtime.onMessage.addListener((n,t,e)=>{if(n.type==="EXTRACT_CONTENT"){console.log("[Content] Extracting content...");const o=g.extract(),i=o.contentScore<500;e({success:!0,data:o,isLowQuality:i})}else if(n.type==="HIGHLIGHT_CITATION"){console.log("[Content] Highlighting block:",n.blockId);const o=p.highlight(n.blockId);e({success:o})}else if(n.type==="START_SELECTION")return console.log("[Content] Starting region selection..."),b.start().then(o=>{console.log("[Content] Selection complete:",o),e({success:!0,rect:o})}),!0});
