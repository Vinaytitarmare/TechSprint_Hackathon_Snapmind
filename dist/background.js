import{a as i}from"./assets/api.Vh5jV6iJ.js";async function g(e=null){try{console.log(`[Capture] Taking screenshot of window: ${e||"current"}`);const t=await chrome.tabs.captureVisibleTab(e,{format:"jpeg",quality:80});if(!t)throw new Error("Captured dataUrl is empty or null");return t}catch(t){console.error("Screenshot capture failed:",t);const r=t.message||"Unknown error";throw new Error(`Screen capture failed (Window: ${e||"default"}). Chrome Error: ${r}. Note: This fails on chrome:// pages or local files (file://) without permission.`)}}console.log("Context-Aware Browser Intelligence: Background Worker loaded");let d=[];chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(e=>console.error(e));chrome.runtime.onInstalled.addListener(()=>{console.log("SnapMind Installed/Updated"),chrome.contextMenus.create({id:"send-to-snapmind",title:"Send to SnapMind",contexts:["selection"]})});chrome.contextMenus.onClicked.addListener(async(e,t)=>{if(e.menuItemId==="send-to-snapmind"&&e.selectionText){console.log("Context Menu Clicked:",e.selectionText);try{await chrome.sidePanel.open({windowId:t.windowId})}catch(r){console.warn("Could not open sidepanel (might already be open or restricted):",r)}setTimeout(()=>{chrome.runtime.sendMessage({type:"SET_CHAT_QUERY",text:e.selectionText}).catch(r=>console.log("Panel not ready yet, message might be missed:",r))},500)}});chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.type==="PROCESS_QUERY")return m(e).then(r),!0;if(e.type==="CAPTURE_VISIBLE_TAB")return g(e.windowId).then(s=>r({success:!0,dataUrl:s})).catch(s=>r({success:!1,error:s.message})),!0;if(e.type==="INGEST_PAGE")return h(e).then(r),!0});let c=null;async function h(e){const{url:t,text:r,crawl:s,maxPages:l,maxDepth:u}=e;if(r)try{return await i.ingestText(t,r)}catch(o){return{success:!1,error:o.message}}let n=!1;try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(o?.id){const a=await chrome.tabs.sendMessage(o.id,{type:"EXTRACT_CONTENT"});a&&a.isLowQuality&&(n=!0)}}catch(o){console.warn("Could not check page quality:",o)}try{return{...await i.ingestPage(t,{crawl:s,maxPages:l,maxDepth:u}),isLowQuality:n}}catch(o){return{success:!1,error:o.message||String(o)||"Unknown Ingestion Error",isLowQuality:n}}}async function m(e){try{const{mode:t,text:r,tabId:s,windowId:l,backendMode:u}=e;if(console.log(`[Background] Processing ${t} query: "${r}"`),t==="visual"){let n;const o=r.includes("Describe the visual layout");return e.imageData?(console.log("[Background] Using client-provided image (Crop)..."),n=e.imageData,c=n):o||!c?(console.log("[Background] Capturing new screenshot..."),n=await g(l),c=n):(console.log("[Background] Reusing cached screenshot for follow-up..."),n=c),{success:!0,...await i.analyzeImage(n,r,u)}}else if(t==="rag")try{const n=await chrome.tabs.sendMessage(s,{type:"EXTRACT_CONTENT"});if(n&&n.data)return d=n.data.blocks,{success:!0,...await i.queryRag(d,r)}}catch(n){return console.warn("Could not contact content script. Is it injected?",n),{success:!1,error:"Could not read page content. Try refreshing the page."}}return{success:!1,error:"Unknown mode"}}catch(t){return console.error("Query processing failed:",t),{success:!1,error:t.message}}}
