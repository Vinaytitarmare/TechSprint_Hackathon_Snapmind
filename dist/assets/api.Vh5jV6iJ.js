const p="AIzaSyAik8tzY5M4KFBbPuBaxTxvBGIPxJzhJZY",y={async getApiKey(){return new Promise(n=>{chrome.storage.local.get(["geminiApiKey"],s=>{n(s.geminiApiKey||p)})})},async analyzeImage(n,s,c="qa"){const r=await new Promise(t=>{chrome.storage.local.get(["backendUrl"],e=>{t(e.backendUrl||"http://127.0.0.1:8000")})});try{console.log(`[API] Sending image to ${r}/analyze-image (Mode: ${c})...`);const t=await fetch(`${r}/analyze-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_data:n,prompt:s,mode:c})}),e=await t.json();if(!t.ok)throw new Error(e.detail||`Backend Error: ${t.status}`);return{answer:e.answer,sources:[]}}catch(t){return console.error("Backend Vision Error:",t),{answer:t.message.includes("Failed to fetch")?`❌ **Connection Refused**: Cannot reach \`${r}\`.

Ensure \`uvicorn main:app --reload\` is running.`:`Error analyzing image: ${t.message}`}}},async queryRag(n,s){console.log("[API] Sending RAG Query to Backend...",{count:n.length,question:s});const c=n.map(e=>e.text).join(`

`),r=await new Promise(e=>{chrome.storage.local.get(["backendUrl"],a=>{e(a.backendUrl||"http://127.0.0.1:8000")})}),t=`${r}/chat`;try{console.log(`[API] Fetching ${t}...`);const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s,content_blocks:n,page_content:c})});if(!e.ok){const i=await e.text();throw console.error(`[API] Backend responded with ${e.status}:`,i),new Error(`Server returned ${e.status}: ${i}`)}const a=await e.json(),d=/\[(bi-block-\d+)\]/g,g=[];let h;for(;(h=d.exec(a.answer))!==null;){const i=h[1];g.find(u=>u.blockId===i)||g.push({blockId:i,snippet:`Source Reference ${i}`})}return{answer:a.answer,citations:g}}catch(e){return console.error("RAG Backend Error:",e),{answer:e.message.includes("Failed to fetch")||e.message.includes("NetworkError")?`❌ **Connection Refused**: Cannot reach \`${r}\`. 

**Possible Fixes**:
1. Ensure Backend is running: \`uvicorn main:app --reload\`
2. Check the **Server URL** in Extension Settings.`:`❌ **Backend Error**: ${e.message}`,citations:[]}}},async ingestPage(n,s={}){const o=await new Promise(t=>{chrome.storage.local.get(["backendUrl"],e=>{t(e.backendUrl||"http://127.0.0.1:8000")})}),r=`${o}/ingest`;try{console.log(`[API] Ingesting ${n} to ${r}...`,s);const t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,crawl:s.crawl||!1,max_pages:s.maxPages||50,max_depth:s.maxDepth||3})}),e=await t.json();if(!t.ok)throw new Error(e.detail||`Ingest failed: ${t.status}`);return{success:!0,message:e.message,chunks_count:e.chunks_count,pages_indexed:e.pages_indexed}}catch(t){return console.error("Ingest Error:",t),{success:!1,message:t.message.includes("Failed to fetch")?`Cannot reach Backend at ${o}`:t.message}}},async ingestText(n,s){const o=await new Promise(t=>{chrome.storage.local.get(["backendUrl"],e=>{t(e.backendUrl||"http://127.0.0.1:8000")})}),r=`${o}/ingest`;try{console.log(`[API] Ingesting text for ${n} to ${r}...`);const t=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,text_content:s})}),e=await t.json();if(!t.ok)throw new Error(e.detail||`Text Ingestion failed: ${t.status}`);return{success:!0,message:e.message}}catch(t){return console.error("Text Ingestion Error:",t),{success:!1,message:t.message.includes("Failed to fetch")?`Cannot reach Backend at ${o}`:t.message}}},async streamQueryRag(n,s,c,o=null,r=null){console.log("[API] Stream RAG request...",o?`(Site: ${o})`:"");const e=await new Promise(a=>chrome.storage.local.get(["backendUrl"],d=>a(d.backendUrl||"http://127.0.0.1:8000")));try{const a=await fetch(`${e}/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:s,content_blocks:n,page_content:n.map(i=>i.text).join(`

`),site_id:o,history:r})});if(!a.ok)throw new Error(`Stream Error: ${a.status}`);const d=a.body.getReader(),g=new TextDecoder;let h={};for(;;){const{done:i,value:u}=await d.read();if(i)break;const w=g.decode(u,{stream:!0}).split(`
`).filter(m=>m.trim()!=="");for(const m of w)try{const l=JSON.parse(m);l.type==="token"?c(l.text):(l.type==="usage"||l.type==="error")&&(h=l)}catch(l){console.warn("Stream parse error",l)}}return{success:!0,...h}}catch(a){return console.error("Stream error",a),{success:!1,error:a.message}}},async getSites(){const s=await new Promise(c=>chrome.storage.local.get(["backendUrl"],o=>c(o.backendUrl||"http://127.0.0.1:8000")));try{const c=await fetch(`${s}/sites`);if(!c.ok)throw new Error("Failed to fetch sites");return(await c.json()).sites||[]}catch(c){return console.error("Get Sites Error",c),[]}},async deleteSite(n){const c=await new Promise(o=>chrome.storage.local.get(["backendUrl"],r=>o(r.backendUrl||"http://127.0.0.1:8000")));try{if(!(await fetch(`${c}/sites/${n}`,{method:"DELETE"})).ok)throw new Error("Failed to delete site");return{success:!0}}catch(o){return console.error("Delete Site Error",o),{success:!1,error:o.message}}},async exportSite(n,s="json"){const o=`http://127.0.0.1:8000/export/${encodeURIComponent(n)}?format=${s}`;try{const r=await fetch(o);if(!r.ok)throw new Error(`Export failed: ${r.statusText}`);const t=await r.blob(),e=window.URL.createObjectURL(t),a=document.createElement("a");return a.href=e,a.download=`export_${n.replace(/[^a-z0-9]/gi,"_")}.${s==="json"?"json":"txt"}`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(e),{success:!0}}catch(r){return console.error("Export error:",r),{success:!1,error:r.message}}}};export{y as a};
